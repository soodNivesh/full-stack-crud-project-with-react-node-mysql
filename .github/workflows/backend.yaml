######  CI + CD for Auth Service (Cloud Run Deployment) ##########
name: ProjectService-dev-deploy

on:
  workflow_dispatch:
  push:
    branches:
      - dev
    paths:
      - "apps/backend/project-service/**"
      - "libs/**"
      - "proto/**"
      #- ".github/workflows/project-service-dev.yaml"  
  pull_request:
    branches:
      - dev
    paths:
      - "apps/backend/project-service/**"
      - "libs/**"
      - "proto/**"
      - ".github/workflows/project-service-dev.yaml"

env:
  PROJECT_ID: rapidqs-lightspeed
  REGION: us-east4
  REPO_NAME: ci-cd-repo            # Artifact Registry repo name
  SERVICE_NAME: project-service
  IMAGE: us-east4-docker.pkg.dev/rapidqs-lightspeed/ci-cd-repo/project-service
  PROJECT_SERVICE_PATH: apps/backend/project-service
  DOCKERFILE_PATH: apps/backend/project-service/Dockerfile
  WORKLOAD_IDENTITY_PROVIDER: projects/444552724942/locations/global/workloadIdentityPools/pool/providers/provider
  SERVICE_ACCOUNT: github-service-account@rapidqs-lightspeed.iam.gserviceaccount.com
  SECRET_ENV: project-service-secret
  SECRET_DOCKER: project-service-secret-docker
  CLOUD_RUN_SERVICE: rapidqs-lightspeed-cicd-project-service
  VPC_CONNECTOR: rapidqs-connector
  VPC_EGRESS: all

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: dev

      # 2️⃣ Authenticate with Google Cloud
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      # 3️⃣ Setup gcloud CLI
      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # 4️⃣ Retrieve secrets
      - name: Fetch secrets from Secret Manager
        run: |
          gcloud secrets versions access latest --secret="${{ env.SECRET_ENV }}" > ${{ env.PROJECT_SERVICE_PATH }}/.env
          gcloud secrets versions access latest --secret="${{ env.SECRET_DOCKER }}" > ${{ env.PROJECT_SERVICE_PATH }}/.env.docker

      # 5️⃣ Install dependencies & build app
      - name: Install dependencies
        run: |
          npm install
          npm install --save-dev webpack webpack-cli webpack-node-externals ts-loader
          npx nx build project-service --verbose --no-cloud

      # 6️⃣ Build Docker image (tag with commit SHA)
      - name: Build Docker image
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker build -t ${{ env.SERVICE_NAME }}:${IMAGE_TAG} -f ${{ env.DOCKERFILE_PATH }} .

      # 7️⃣ Push Docker image to Artifact Registry
      - name: Push to Artifact Registry
        run: |
          IMAGE_TAG=${{ github.sha }}
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
          docker tag ${{ env.SERVICE_NAME }}:${IMAGE_TAG} ${{ env.IMAGE }}:${IMAGE_TAG}
          docker push ${{ env.IMAGE }}:${IMAGE_TAG}

      # 8️⃣ Deploy to Cloud Run (create new revision)
      - name: Deploy to Cloud Run
        run: |
          IMAGE_TAG=${{ github.sha }}
          gcloud run deploy ${{ env.CLOUD_RUN_SERVICE }} \
            --image ${{ env.IMAGE }}:${IMAGE_TAG} \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --vpc-connector ${{ env.VPC_CONNECTOR }} \
            --vpc-egress ${{ env.VPC_EGRESS }} \
            --project ${{ env.PROJECT_ID }}

      # ✅ Optional: print deployed image for debugging
      - name: Confirm Deployment
        run: |
          echo "Deployed revision for ${{ env.CLOUD_RUN_SERVICE }} with image tag: ${{ github.sha }}"
